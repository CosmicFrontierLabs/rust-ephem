name: Build Dev Wheels

on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            publish_testpypi:
                description: "Publish to TestPyPI"
                required: false
                default: false
                type: boolean

permissions:
    contents: read

jobs:
    build-linux-x86_64:
        name: Build Linux x86_64 wheels
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set version from git tag
              run: |
                  VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  rm -f Cargo.toml.bak

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Install maturin
              run: pip install maturin

            - name: Build wheels
              run: maturin build --release --out dist

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux-x86_64
                  path: dist/*.whl

    build-sdist:
        name: Build source distribution
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set version from git tag
              run: |
                  VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  rm -f Cargo.toml.bak

            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist/*.tar.gz

    publish-testpypi:
        name: Publish to TestPyPI
        runs-on: ubuntu-latest
        needs: [build-linux-x86_64, build-sdist]
        if: github.event_name == 'workflow_dispatch' && inputs.publish_testpypi
        permissions:
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist-artifacts

            - name: Consolidate artifacts
              run: |
                  mkdir -p dist
                  find dist-artifacts -name '*.whl' -exec mv {} dist/ \;
                  find dist-artifacts -name '*.tar.gz' -exec mv {} dist/ \;
                  ls -lh dist/

            - name: Publish to TestPyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  repository-url: https://test.pypi.org/legacy/
                  skip-existing: true
