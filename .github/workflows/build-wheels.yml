name: Build Release Wheels

on:
    push:
        branches:
            - main
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            publish_testpypi:
                description: "Publish to TestPyPI"
                required: false
                default: false
                type: boolean

permissions:
    contents: read

jobs:
    build-wheels:
        name: Build wheels on ${{ matrix.os }} - ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux x86_64
                    - os: ubuntu-latest
                      target: x86_64
                      container: off

                    # Linux aarch64
                    - os: ubuntu-latest
                      target: aarch64
                      container: auto

                    # macOS x86_64 (Intel)
                    - os: macos-13
                      target: x86_64-apple-darwin

                    # macOS aarch64 (Apple Silicon)
                    - os: macos-14
                      target: aarch64-apple-darwin

                    # Windows x86_64 - temporarily disabled
                    # - os: windows-latest
                    #   target: x86_64-pc-windows-msvc

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set version from git tag
              shell: bash
              run: |
                  if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/v}
                  else
                    VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "Building version: $VERSION"

                  # Update Cargo.toml with version
                  if [[ "$RUNNER_OS" == "Windows" ]]; then
                    sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  else
                    sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                    rm -f Cargo.toml.bak
                  fi

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              if: matrix.container != 'auto'
              uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.target }}
                  cache-on-failure: true
                  workspaces: "."

            - name: Set up QEMU (for cross-compilation on Linux)
              if: runner.os == 'Linux' && matrix.target == 'aarch64'
              uses: docker/setup-qemu-action@v3
              with:
                  platforms: arm64

            - name: Build wheels (Linux)
              if: runner.os == 'Linux'
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist --interpreter 3.10 3.11 3.12 3.13
                  manylinux: ${{ matrix.container || 'auto' }}
              env:
                  # Fix for ring crate ARM64 cross-compilation
                  CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"

            - name: Build wheels (macOS)
              if: runner.os == 'macOS'
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist --interpreter 3.10 3.11 3.12 3.13

            - name: Build wheels (Windows)
              if: runner.os == 'Windows'
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist --interpreter 3.10 3.11 3.12 3.13

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-${{ matrix.os }}-${{ matrix.target }}
                  path: dist/*.whl
                  if-no-files-found: error

            - name: List built wheels
              shell: bash
              run: |
                  echo "Built wheels:"
                  ls -lh dist/

    build-sdist:
        name: Build source distribution
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set version from git tag
              run: |
                  if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/v}
                  else
                    VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.1.0")
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  sed -i.bak "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
                  rm -f Cargo.toml.bak

            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist/*.tar.gz

    publish-testpypi:
        name: Publish to TestPyPI
        runs-on: ubuntu-latest
        needs: [build-wheels, build-sdist]
        if: github.event_name == 'workflow_dispatch' && inputs.publish_testpypi
        permissions:
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist-artifacts

            - name: Consolidate artifacts
              run: |
                  mkdir -p dist
                  find dist-artifacts -name '*.whl' -exec mv {} dist/ \;
                  find dist-artifacts -name '*.tar.gz' -exec mv {} dist/ \;
                  ls -lh dist/

            - name: Publish to TestPyPI
              uses: PyO3/maturin-action@v1
              with:
                  command: upload
                  args: --non-interactive --skip-existing dist/* --repository-url https://test.pypi.org/legacy/

    publish:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        needs: [build-wheels, build-sdist]
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        permissions:
            id-token: write # For trusted publishing
            contents: write # For creating GitHub releases

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist-artifacts

            - name: Consolidate artifacts
              run: |
                  mkdir -p dist
                  find dist-artifacts -name '*.whl' -exec mv {} dist/ \;
                  find dist-artifacts -name '*.tar.gz' -exec mv {} dist/ \;
                  ls -lh dist/

            - name: Publish to PyPI
              uses: PyO3/maturin-action@v1
              with:
                  command: upload
                  args: --non-interactive --skip-existing dist/*

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/v')
              with:
                  files: dist/*
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
